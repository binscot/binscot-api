<!DOCTYPE html>
<html lang="">
<head>
    <title>WebSocket Chat</title>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const input = document.getElementById("message");
        input.focus();
    });
</script>
</head>
<body>
<h1>WebSocket Chat</h1>
<div id="chat"></div>
<label for="message"></label><input type="text" id="message" placeholder="Type your message" onkeyup="handleKeyPress(event)" >
<button onclick="sendMessage()">Send</button>
<button onclick="closeConnection()">Disconnect</button>
<script>
    let username = prompt("Enter your username:");
    let room_name = prompt("Enter your roomname:");

    if(username !== null) {
        const createRoomData = {
            room_name: room_name,
            lock: true,
            hashed_password: null,
            limit_number_rooms: 3,
            user_in_room: null
        };

        fetch("http://127.0.0.1:8000/api/v1/chat/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(createRoomData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("Room created:", data);
            initializeWebSocket(data.id);
        })
        .catch(error => {
            console.error("Error creating room:", error);
        });
    }

    function initializeWebSocket(roomId) {
        const socket = new WebSocket(`ws://127.0.0.1:8000/api/v1/chat/ws/${roomId}/${username}`);
        socket.onmessage = event => {
            const chatDiv = document.getElementById("chat");
            const messageData = JSON.parse(event.data);
            const messageDiv = document.createElement("div");
            messageDiv.textContent = `${messageData.author}: ${messageData.message}`;
            chatDiv.appendChild(messageDiv);
        };
        
        window.socket = socket; // 소켓 객체를 전역 변수로 설정하여 다른 함수에서도 사용 가능하도록 합니다.
    }

    function sendMessage() {
        const input = document.getElementById("message");
        const message = input.value;
        const messageData = {
            author: username,
            message: message
        };
        window.socket.send(JSON.stringify(messageData));
        input.value = "";
    }

    function closeConnection() {
        window.socket.close();
        console.log("WebSocket connection closed");
    }

    function handleKeyPress(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // 기본 동작 중단
            sendMessage();
        }
    }
</script>
</body>
</html>